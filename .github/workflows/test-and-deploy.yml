name: Test and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Test webhook function
      run: |
        cd api
        python -c "
        import sys
        sys.path.append('.')
        from webhook import validate_signal_data

        # Test valid signal
        valid_signal = {'ticker': 'AAPL', 'action': 'BUY', 'price': 150.0}
        is_valid, msg = validate_signal_data(valid_signal)
        assert is_valid, f'Valid signal test failed: {msg}'
        print('‚úÖ Valid signal test passed')

        # Test invalid signal
        invalid_signal = {'ticker': 'AAPL'}  # missing action
        is_valid, msg = validate_signal_data(invalid_signal)
        assert not is_valid, 'Invalid signal should fail validation'
        print('‚úÖ Invalid signal test passed')

        print('‚úÖ All webhook tests passed!')
        "

    - name: Validate HTML
      run: |
        # Check HTML file structure
        grep -q '<title>' index.html && echo '‚úÖ Title found' || exit 1
        grep -q 'Mathematricks' index.html && echo '‚úÖ Branding found' || exit 1
        grep -q 'contact' index.html && echo '‚úÖ Contact form found' || exit 1
        echo '‚úÖ HTML validation passed'

    - name: Test configuration files
      run: |
        # Check Netlify config
        [ -f "netlify.toml" ] && echo "‚úÖ Netlify config found" || exit 1

        # Check Vercel config
        [ -f "vercel.json" ] && echo "‚úÖ Vercel config found" || exit 1

        # Check webhook API
        [ -f "api/webhook.py" ] && echo "‚úÖ Webhook API found" || exit 1

        echo "‚úÖ All configuration files valid"

  deploy-notification:
    name: Deployment Status
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Deployment started
      run: |
        echo "üöÄ Deploying Mathematricks Capital..."
        echo "Website: Netlify will auto-deploy from main branch"
        echo "Webhook: Vercel will auto-deploy from main branch"
        echo "Both services deploy automatically - no action needed!"

  security-check:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for secrets
      run: |
        echo "üîí Running security checks..."

        # Check for potential secrets (but allow legitimate references)
        if grep -r "password\|secret\|key" . --exclude-dir=.git --exclude-dir=.github | grep -v "WEBHOOK_PASSPHRASE" | grep -v "# " | grep -v "TODO" | grep -v ".md:"; then
          echo "‚ö†Ô∏è Potential secrets found - please review"
        else
          echo "‚úÖ No hardcoded secrets detected"
        fi

        # Check .env is ignored
        if grep -q "\.env" .gitignore; then
          echo "‚úÖ .env properly ignored"
        else
          echo "‚ö†Ô∏è Add .env to .gitignore"
        fi

    - name: Webhook security check
      run: |
        cd api
        if grep -q "os.environ.get.*WEBHOOK_PASSPHRASE" webhook.py; then
          echo "‚úÖ Webhook uses environment variables for security"
        else
          echo "‚ùå Webhook should use environment variables"
          exit 1
        fi

  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check file sizes
      run: |
        echo "üìä Checking file sizes for performance..."

        HTML_SIZE=$(wc -c < index.html)
        echo "HTML size: ${HTML_SIZE} bytes"

        if [ $HTML_SIZE -gt 1000000 ]; then
          echo "‚ö†Ô∏è HTML file is large (${HTML_SIZE} bytes) - consider optimization"
        else
          echo "‚úÖ HTML file size is reasonable"
        fi

    - name: Check for optimization
      run: |
        # Check for minification opportunities
        if grep -q "    " index.html; then
          echo "üí° HTML could be minified for better performance"
        fi

        echo "‚úÖ Performance check completed"